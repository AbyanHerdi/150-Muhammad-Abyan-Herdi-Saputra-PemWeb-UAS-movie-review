<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Submit Review</title>
    <style>
        body {
            font-family: monospace;
            background: #0a0a0a;
            color: #fff;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 { color: #e50914; }
        .section {
            background: #1a1a1a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        .success { border-left-color: #28a745; background: #1a3a1a; }
        .error { border-left-color: #dc3545; background: #3a1a1a; }
        button {
            background: #e50914;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
            font-size: 14px;
            font-weight: bold;
        }
        button:hover { background: #f00; }
        pre {
            background: #2d2d2d;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        input, textarea {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            background: #2d2d2d;
            border: 1px solid #444;
            color: white;
            border-radius: 5px;
        }
        .log-item {
            padding: 10px;
            margin: 5px 0;
            background: #2d2d2d;
            border-radius: 5px;
            border-left: 3px solid #667eea;
        }
        .log-success { border-left-color: #28a745; }
        .log-error { border-left-color: #dc3545; }
        .log-warning { border-left-color: #ffc107; }
    </style>
</head>
<body>
    <h1>üîç Debug Submit Review - Dilan 1990</h1>
    
    <div class="section">
        <h2>1Ô∏è‚É£ Configuration</h2>
        <p>Current URL: <code id="currentUrl"></code></p>
        <p>API URL: <code id="apiUrl"></code></p>
        <label>Movie ID:</label>
        <input type="number" id="movieId" value="3">
        <label>Movie Title:</label>
        <input type="text" id="movieTitle" value="Dilan 1990">
    </div>

    <div class="section">
        <h2>2Ô∏è‚É£ Test Data</h2>
        <label>Your Name:</label>
        <input type="text" id="userName" value="Test User" placeholder="Your name">
        
        <label>Rating (1-5):</label>
        <input type="number" id="rating" value="5" min="1" max="5">
        
        <label>Review Text:</label>
        <textarea id="reviewText" rows="4" placeholder="Write your review...">Film yang sangat bagus! Milea, kamu cantik.</textarea>
        
        <button onclick="testSubmit()">üöÄ Submit Review</button>
        <button onclick="testGetReviews()">üì• Get Reviews</button>
        <button onclick="clearLogs()">üóëÔ∏è Clear Logs</button>
    </div>

    <div class="section">
        <h2>3Ô∏è‚É£ Request/Response Logs</h2>
        <div id="logs"></div>
    </div>

    <div class="section">
        <h2>4Ô∏è‚É£ Database Check</h2>
        <button onclick="checkDatabase()">üîç Check Database Status</button>
        <div id="dbStatus"></div>
    </div>

    <script>
        const logs = [];
        let API_BASE = 'api';

        // Auto-detect API URL
        const currentUrl = window.location.href;
        document.getElementById('currentUrl').textContent = currentUrl;

        if (currentUrl.includes('localhost') || currentUrl.includes('127.0.0.1')) {
            const pathMatch = currentUrl.match(/(http:\/\/[^\/]+\/[^\/]+)\//);
            if (pathMatch) {
                API_BASE = pathMatch[1] + '/api';
            } else {
                API_BASE = 'http://localhost/movie-review/api';
            }
        }

        document.getElementById('apiUrl').textContent = API_BASE;

        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('logs');
            
            const logItem = document.createElement('div');
            logItem.className = 'log-item log-' + type;
            logItem.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            
            logDiv.insertBefore(logItem, logDiv.firstChild);
            console.log(`[${timestamp}] ${message}`);
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
            document.getElementById('dbStatus').innerHTML = '';
            addLog('Logs cleared', 'info');
        }

        async function testSubmit() {
            addLog('üöÄ Starting submit test...', 'info');
            
            const movieId = document.getElementById('movieId').value;
            const movieTitle = document.getElementById('movieTitle').value;
            const userName = document.getElementById('userName').value;
            const rating = document.getElementById('rating').value;
            const reviewText = document.getElementById('reviewText').value;

            const payload = {
                movie_title: movieTitle,
                rating: parseInt(rating),
                review_text: reviewText,
                user_name: userName
            };

            addLog(`üì§ Payload: <pre>${JSON.stringify(payload, null, 2)}</pre>`, 'info');

            const submitUrl = `${API_BASE}/submit_review.php`;
            addLog(`üåê URL: ${submitUrl}`, 'info');

            try {
                addLog('‚è≥ Sending request...', 'info');
                
                const response = await fetch(submitUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                addLog(`üìä Response Status: ${response.status} ${response.statusText}`, 'info');

                const contentType = response.headers.get('content-type');
                addLog(`üìã Content-Type: ${contentType}`, 'info');

                const responseText = await response.text();
                addLog(`üì• Raw Response:<pre>${responseText}</pre>`, 'info');

                try {
                    const data = JSON.parse(responseText);
                    
                    if (data.success) {
                        addLog(`‚úÖ SUCCESS! Review submitted!<pre>${JSON.stringify(data, null, 2)}</pre>`, 'success');
                        alert('‚úÖ Review berhasil dikirim! Cek database sekarang.');
                        
                        // Auto-refresh reviews
                        setTimeout(() => testGetReviews(), 1000);
                    } else {
                        addLog(`‚ùå FAILED: ${data.message}<pre>${JSON.stringify(data, null, 2)}</pre>`, 'error');
                        alert('‚ùå Error: ' + data.message);
                    }
                } catch (parseError) {
                    addLog(`‚ùå JSON Parse Error: ${parseError.message}`, 'error');
                    addLog(`Response is not valid JSON. Raw response shown above.`, 'error');
                }

            } catch (error) {
                addLog(`‚ùå Network Error: ${error.message}`, 'error');
                alert('‚ùå Network Error: ' + error.message);
            }
        }

        async function testGetReviews() {
            addLog('üì• Getting reviews...', 'info');
            
            const movieId = document.getElementById('movieId').value;
            const getUrl = `${API_BASE}/get_reviews.php?movie_id=${movieId}`;
            
            addLog(`üåê URL: ${getUrl}`, 'info');

            try {
                const response = await fetch(getUrl);
                const data = await response.json();

                addLog(`üìä Response:<pre>${JSON.stringify(data, null, 2)}</pre>`, 'info');

                if (data.success) {
                    addLog(`‚úÖ Found ${data.data.length} reviews`, 'success');
                    addLog(`‚≠ê Average Rating: ${data.stats.average_rating}`, 'success');
                    addLog(`üìù Total Reviews: ${data.stats.total_reviews}`, 'success');
                } else {
                    addLog(`‚ö†Ô∏è No reviews found or error`, 'warning');
                }
            } catch (error) {
                addLog(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function checkDatabase() {
            addLog('üîç Checking database...', 'info');
            
            const dbDiv = document.getElementById('dbStatus');
            dbDiv.innerHTML = '<p style="color:#ffc107;">‚è≥ Checking database via PHP...</p>';

            try {
                // Test 1: Check if API files exist
                const submitTest = await fetch(`${API_BASE}/submit_review.php`, {
                    method: 'OPTIONS'
                });
                
                if (submitTest.ok) {
                    addLog('‚úÖ submit_review.php accessible', 'success');
                } else {
                    addLog('‚ùå submit_review.php not accessible', 'error');
                }

                const getTest = await fetch(`${API_BASE}/get_reviews.php?movie_id=1`);
                if (getTest.ok) {
                    addLog('‚úÖ get_reviews.php accessible', 'success');
                } else {
                    addLog('‚ùå get_reviews.php not accessible', 'error');
                }

                // Test 2: Try to get reviews
                const movieId = document.getElementById('movieId').value;
                const response = await fetch(`${API_BASE}/get_reviews.php?movie_id=${movieId}`);
                const data = await response.json();

                if (data.success) {
                    dbDiv.innerHTML = `
                        <div style="color:#0f0;">
                            <h3>‚úÖ Database Connection OK!</h3>
                            <p>Movie ID ${movieId} found</p>
                            <p>Total Reviews: ${data.stats.total_reviews}</p>
                            <p>Average Rating: ${data.stats.average_rating}</p>
                        </div>
                    `;
                    addLog('‚úÖ Database check passed', 'success');
                } else {
                    dbDiv.innerHTML = `
                        <div style="color:#f00;">
                            <h3>‚ö†Ô∏è Database Issue</h3>
                            <p>${data.message}</p>
                        </div>
                    `;
                    addLog('‚ö†Ô∏è Database check failed: ' + data.message, 'warning');
                }

            } catch (error) {
                dbDiv.innerHTML = `
                    <div style="color:#f00;">
                        <h3>‚ùå Connection Error</h3>
                        <p>${error.message}</p>
                        <p>Make sure XAMPP is running!</p>
                    </div>
                `;
                addLog('‚ùå Connection error: ' + error.message, 'error');
            }
        }

        // Auto-check on load
        window.onload = () => {
            addLog('üé¨ Debug tool loaded', 'info');
            checkDatabase();
        };
    </script>
</body>
</html>