<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Detail Film - CineScope</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Inter', sans-serif;
      background: #f5f5f5;
      padding-top: 80px;
    }
    
    /* Navbar */
    .navbar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px 0;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      z-index: 1000;
    }
    .nav-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .nav-brand h1 {
      color: white;
      font-size: 1.8em;
    }
    .nav-menu a {
      color: white;
      text-decoration: none;
      margin-left: 20px;
      transition: 0.3s;
    }
    .nav-menu a:hover { opacity: 0.8; }
    
    /* Container */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    /* Movie Detail */
    .movie-detail {
      background: white;
      border-radius: 15px;
      padding: 40px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
      display: grid;
      grid-template-columns: 300px 1fr;
      gap: 40px;
      margin-bottom: 30px;
    }
    .movie-poster {
      width: 100%;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    .movie-info h1 {
      font-size: 2.5em;
      color: #333;
      margin-bottom: 10px;
    }
    .movie-meta {
      display: flex;
      gap: 20px;
      margin: 20px 0;
      color: #666;
    }
    .rating-large {
      font-size: 2em;
      color: #ffc107;
      margin: 20px 0;
    }
    .synopsis {
      line-height: 1.8;
      color: #555;
      margin-top: 20px;
    }
    
    /* Review Section */
    .review-section {
      background: white;
      border-radius: 15px;
      padding: 40px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }
    .review-section h2 {
      color: #333;
      margin-bottom: 20px;
      font-size: 1.8em;
    }
    
    /* Review Form */
    .review-form {
      background: #f8f9fa;
      padding: 30px;
      border-radius: 10px;
      margin-bottom: 30px;
    }
    .form-group {
      margin-bottom: 20px;
    }
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
    }
    .rating-input {
      display: flex;
      gap: 10px;
      font-size: 2em;
    }
    .rating-input i {
      cursor: pointer;
      color: #ddd;
      transition: 0.2s;
    }
    .rating-input i:hover,
    .rating-input i.active {
      color: #ffc107;
    }
    textarea {
      width: 100%;
      padding: 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-family: inherit;
      font-size: 1em;
      resize: vertical;
      min-height: 120px;
    }
    textarea:focus {
      outline: none;
      border-color: #667eea;
    }
    .btn {
      padding: 12px 30px;
      border: none;
      border-radius: 8px;
      font-size: 1em;
      font-weight: 600;
      cursor: pointer;
      transition: 0.3s;
    }
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }
    
    /* Review List */
    .review-item {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 15px;
    }
    .review-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    .review-user {
      font-weight: 600;
      color: #333;
    }
    .review-rating {
      color: #ffc107;
    }
    .review-text {
      color: #555;
      line-height: 1.6;
    }
    .review-date {
      color: #999;
      font-size: 0.9em;
      margin-top: 10px;
    }
    
    .message {
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .message.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .message.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    @media (max-width: 768px) {
      .movie-detail { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="nav-container">
      <div class="nav-brand">
        <h1>CineScope</h1>
      </div>
      <div class="nav-menu">
        <a href="user.html">Beranda</a>
        <a href="#" id="logoutBtn">Logout</a>
      </div>
    </div>
  </nav>

  <div class="container">
    <!-- Movie Detail -->
    <div class="movie-detail" id="movieDetail">
      <p style="text-align:center;">Loading...</p>
    </div>

    <!-- Review Section -->
    <div class="review-section">
      <h2><i class="fas fa-star"></i> Reviews & Ratings</h2>
      
      <div id="messageBox"></div>
      
      <!-- Review Form -->
      <div class="review-form" id="reviewForm">
        <h3 style="margin-bottom:20px;">Tulis Review Anda</h3>
        
        <div class="form-group">
          <label>Rating:</label>
          <div class="rating-input" id="ratingInput">
            <i class="fas fa-star" data-rating="1"></i>
            <i class="fas fa-star" data-rating="2"></i>
            <i class="fas fa-star" data-rating="3"></i>
            <i class="fas fa-star" data-rating="4"></i>
            <i class="fas fa-star" data-rating="5"></i>
            <i class="fas fa-star" data-rating="6"></i>
            <i class="fas fa-star" data-rating="7"></i>
            <i class="fas fa-star" data-rating="8"></i>
            <i class="fas fa-star" data-rating="9"></i>
            <i class="fas fa-star" data-rating="10"></i>
          </div>
          <p style="margin-top:10px; color:#666;">Rating terpilih: <span id="selectedRating">0</span>/10</p>
        </div>
        
        <div class="form-group">
          <label>Review:</label>
          <textarea id="reviewText" placeholder="Tulis review Anda tentang film ini..."></textarea>
        </div>
        
        <button class="btn btn-primary" id="submitReview">
          <i class="fas fa-paper-plane"></i> Submit Review
        </button>
      </div>
      
      <!-- Reviews List -->
      <div id="reviewsList">
        <h3 style="margin:30px 0 20px;">Semua Reviews</h3>
        <div id="reviewsContainer">
          <p style="text-align:center; color:#999;">Loading reviews...</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_URL = 'http://localhost/movie-review/api';
    const BASE_URL = 'http://localhost/movie-review/';
    let currentMovieId = null;
    let selectedRating = 0;
    let userToken = localStorage.getItem('userToken');
    
    // Check if logged in
    if (!userToken) {
      // Untuk demo, buat token dummy
      // Nanti ganti dengan login real
      userToken = 'dummy_token_for_demo';
      localStorage.setItem('userToken', userToken);
    }
    
    // Get movie ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    currentMovieId = urlParams.get('id');
    
    if (!currentMovieId) {
      window.location.href = 'user.html';
    }
    
    // Load movie detail
    async function loadMovieDetail() {
      try {
        const response = await fetch(`${API_URL}/movies/get_detail.php?id=${currentMovieId}`);
        const result = await response.json();
        
        if (result.success && result.data) {
          const m = result.data;
          const posterUrl = m.poster ? BASE_URL + m.poster : 'https://via.placeholder.com/300x450';
          
          document.getElementById('movieDetail').innerHTML = `
            <img src="${posterUrl}" alt="${m.title}" class="movie-poster" onerror="this.src='https://via.placeholder.com/300x450'">
            <div class="movie-info">
              <h1>${m.title}</h1>
              ${m.original_title ? `<p style="color:#999;">${m.original_title}</p>` : ''}
              <div class="movie-meta">
                <span><i class="fas fa-calendar"></i> ${m.release_year || 'N/A'}</span>
                <span><i class="fas fa-clock"></i> ${m.duration ? m.duration + ' menit' : 'N/A'}</span>
              </div>
              <div class="rating-large">
                <i class="fas fa-star"></i> ${parseFloat(m.average_rating).toFixed(1)}/10
                <span style="font-size:0.5em; color:#999;">(${m.total_reviews} reviews)</span>
              </div>
              <p><strong>Genre:</strong> ${m.genre || 'Unknown'}</p>
              ${m.director ? `<p><strong>Sutradara:</strong> ${m.director}</p>` : ''}
              <div class="synopsis">
                <h3>Sinopsis</h3>
                <p>${m.synopsis || 'Tidak ada sinopsis tersedia.'}</p>
              </div>
            </div>
          `;
          document.title = m.title + ' - CineScope';
        }
      } catch (error) {
        console.error('Error loading movie:', error);
      }
    }
    
    // Load reviews
    async function loadReviews() {
      try {
        const response = await fetch(`${API_URL}/reviews/get_by_movie.php?movie_id=${currentMovieId}`);
        const result = await response.json();
        
        const container = document.getElementById('reviewsContainer');
        
        if (result.success && result.data.reviews && result.data.reviews.length > 0) {
          container.innerHTML = '';
          result.data.reviews.forEach(review => {
            const reviewItem = `
              <div class="review-item">
                <div class="review-header">
                  <span class="review-user">
                    <i class="fas fa-user-circle"></i> ${review.username}
                  </span>
                  <span class="review-rating">
                    <i class="fas fa-star"></i> ${review.rating}/10
                  </span>
                </div>
                <div class="review-text">${review.review_text || 'Tidak ada komentar'}</div>
                <div class="review-date">
                  <i class="fas fa-clock"></i> ${new Date(review.created_at).toLocaleString('id-ID')}
                </div>
              </div>
            `;
            container.innerHTML += reviewItem;
          });
        } else {
          container.innerHTML = '<p style="text-align:center; color:#999;">Belum ada review untuk film ini</p>';
        }
      } catch (error) {
        console.error('Error loading reviews:', error);
      }
    }
    
    // Rating stars interaction
    const ratingStars = document.querySelectorAll('#ratingInput i');
    ratingStars.forEach(star => {
      star.addEventListener('click', function() {
        selectedRating = parseInt(this.dataset.rating);
        document.getElementById('selectedRating').textContent = selectedRating;
        
        ratingStars.forEach(s => {
          const rating = parseInt(s.dataset.rating);
          if (rating <= selectedRating) {
            s.classList.add('active');
          } else {
            s.classList.remove('active');
          }
        });
      });
    });
    
    // Submit review (SIMPAN KE DATABASE)
    document.getElementById('submitReview').addEventListener('click', async function() {
      const reviewText = document.getElementById('reviewText').value.trim();
      const messageBox = document.getElementById('messageBox');
      
      if (selectedRating === 0) {
        messageBox.innerHTML = '<div class="message error">Pilih rating terlebih dahulu!</div>';
        return;
      }
      
      if (!reviewText) {
        messageBox.innerHTML = '<div class="message error">Tulis review Anda!</div>';
        return;
      }
      
      try {
        // SIMPAN KE DATABASE via API
        const response = await fetch(`${API_URL}/reviews/create.php`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${userToken}`
          },
          body: JSON.stringify({
            movie_id: currentMovieId,
            rating: selectedRating,
            review_text: reviewText,
            is_spoiler: false
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          messageBox.innerHTML = '<div class="message success">✅ Review berhasil disimpan!</div>';
          
          // Reset form
          document.getElementById('reviewText').value = '';
          selectedRating = 0;
          document.getElementById('selectedRating').textContent = '0';
          ratingStars.forEach(s => s.classList.remove('active'));
          
          // Reload reviews dan movie detail
          setTimeout(() => {
            loadReviews();
            loadMovieDetail();
            messageBox.innerHTML = '';
          }, 2000);
        } else {
          messageBox.innerHTML = `<div class="message error">❌ ${result.message}</div>`;
        }
      } catch (error) {
        console.error('Error:', error);
        messageBox.innerHTML = '<div class="message error">❌ Terjadi kesalahan saat menyimpan review</div>';
      }
    });
    
    // Logout
    document.getElementById('logoutBtn').addEventListener('click', function(e) {
      e.preventDefault();
      localStorage.removeItem('userToken');
      window.location.href = 'user.html';
    });
    
    // Initialize
    loadMovieDetail();
    loadReviews();
  </script>
</body>
</html>